---
- hosts: localhost
  become: true
  vars_files:
    - vars.yml
    - host_vars.yml
  handlers:
    - import_tasks: handlers/main.yml
  tasks:
  - name: Detect system UUID
    command: dmidecode -s system-uuid
    register: system_uuid_raw
    changed_when: false

  - name: Set system UUID fact
    set_fact:
      system_uuid: "{{ system_uuid_raw.stdout | trim | lower }}"

  - name: Check if ssh playbook should run on this host
    set_fact:
      should_run: "{{ 'ssh' in hosts[system_uuid].playbooks | default([]) }}"
    when: system_uuid in hosts

  - name: Skip playbook if not configured for this host
    meta: end_play
    when: not (should_run | default(false))

  - name: Display playbook being run
    debug:
      msg: "===== Running SSH Security Configuration Playbook ====="

  - name: Load host-specific configuration
    set_fact:
      domain_name: "{{ hosts[system_uuid].domain_name }}"
      ssl_email: "{{ hosts[system_uuid].ssl_email }}"
      ssh_public_key: "{{ hosts[system_uuid].ssh_public_key }}"
    when: system_uuid in hosts

  - name: Fail if system UUID not found in host_vars.yml
    fail:
      msg: "System UUID {{ system_uuid }} not found in host_vars.yml. Please add configuration for this host."
    when: system_uuid not in hosts

  - name: Display loaded configuration
    debug:
      msg: "Loaded configuration for system UUID: {{ system_uuid }}, domain: {{ domain_name }}"

  - name: Configure UFW rules
    ufw:
      rule: allow
      name: "{{ item.name }}"
    loop: "{{ ssh_ufw_rules }}"

  - name: Get current user info
    getent:
      database: passwd
      key: "{{ ansible_user_id }}"
    register: user_info

  - name: Set home directory fact
    set_fact:
      user_home: "{{ user_info.ansible_facts.getent_passwd[ansible_user_id][4] }}"

  - name: Ensure .ssh directory exists
    file:
      path: "{{ user_home }}/.ssh"
      state: directory
      mode: '0700'
      owner: "{{ ansible_user_id }}"
      group: "{{ ansible_user_id }}"

  # TODO: In the future, support multiple SSH keys
  - name: Add SSH public key to authorized_keys
    authorized_key:
      user: "{{ ansible_user_id }}"
      state: present
      key: "{{ ssh_public_key }}"
      comment: "philip@DESKTOP-MGCFDQD"

  - name: Configure OpenSSH server
    template:
      src: sshd_config.j2
      dest: /etc/ssh/sshd_config
      mode: '0644'
      backup: yes
    notify: restart sshd

  - name: Check if cloud-init SSH config exists
    stat:
      path: /etc/ssh/sshd_config.d/50-cloud-init.conf
    register: cloud_init_ssh_config

  - name: Disable password authentication in cloud-init config
    lineinfile:
      path: /etc/ssh/sshd_config.d/50-cloud-init.conf
      regexp: '^PasswordAuthentication'
      line: 'PasswordAuthentication no'
      backup: yes
    when: cloud_init_ssh_config.stat.exists
    notify: restart sshd

  - name: Remove cloud-init SSH config file (alternative approach)
    file:
      path: /etc/ssh/sshd_config.d/50-cloud-init.conf
      state: absent
    when: cloud_init_ssh_config.stat.exists
    notify: restart sshd