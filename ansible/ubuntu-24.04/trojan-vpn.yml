---
- hosts: localhost
  become: true
  vars_files:
    - vars.yml
  handlers:
    - import_tasks: handlers/main.yml
  tasks:
  - name: Install required packages
    apt:
      name: "{{ required_packages }}"
      state: present
      update_cache: yes
  - name: Ensure UFW is enabled
    ufw:
      state: enabled
      policy: "{{ ufw_policy }}"
  
  - name: Configure UFW rules
    ufw:
      rule: allow
      name: "{{ item.name }}"
    loop: "{{ ufw_rules }}"

  - name: Start and enable Nginx
    ansible.builtin.systemd:
      name: nginx
      state: started
      enabled: yes

  - name: Ensure webroot directory exists
    file:
      path: /var/www/html
      state: directory
      mode: '0755'

  - name: Obtain SSL certificate with Certbot (webroot mode)
    command: >
      certbot certonly --webroot -w /var/www/html -n --agree-tos --email {{ ssl_email }} -d {{ domain_name }}
    register: certbot_result
    changed_when: "'Certificate not yet due for renewal' not in certbot_result.stdout"
    failed_when: certbot_result.rc != 0 and 'Certificate not yet due for renewal' not in certbot_result.stdout

  - name: Fix Let's Encrypt live directory permissions
    file:
      path: /etc/letsencrypt/live
      mode: '0755'
      state: directory

  - name: Fix Let's Encrypt archive directory permissions
    file:
      path: /etc/letsencrypt/archive
      mode: '0755'
      state: directory

  - name: Fix Let's Encrypt domain archive permissions
    file:
      path: "/etc/letsencrypt/archive/{{ domain_name }}"
      mode: '0755'
      state: directory
      recurse: yes

  - name: Remove Certbot's SSL configuration from Nginx (Trojan will handle 443)
    replace:
      path: "/etc/nginx/sites-available/{{ domain_name }}"
      regexp: '(?s)listen 443 ssl;.*?ssl_dhparam.*?\.pem;.*?# managed by Certbot'
      replace: ''
    notify: reload nginx
    when: certbot_result is defined

  - name: Ensure Nginx only listens on port 80
    lineinfile:
      path: "/etc/nginx/sites-available/{{ domain_name }}"
      regexp: '^\s*listen 443'
      state: absent
    notify: reload nginx

  - name: Check if Trojan password file exists
    stat:
      path: /root/trojan-password.txt
    register: password_file

  - name: Generate random Trojan password (only if not exists)
    set_fact:
      trojan_password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"
    when: not password_file.stat.exists

  - name: Read existing Trojan password (if exists)
    slurp:
      src: /root/trojan-password.txt
    register: existing_password
    when: password_file.stat.exists

  - name: Set Trojan password from existing file
    set_fact:
      trojan_password: "{{ existing_password.content | b64decode | trim }}"
    when: password_file.stat.exists

  - name: Remove default Nginx site
    file:
      path: /etc/nginx/sites-enabled/default
      state: absent
    notify: reload nginx

  - name: Check if Nginx site config already exists
    stat:
      path: "/etc/nginx/sites-available/{{ domain_name }}"
    register: nginx_site_exists

  - name: Configure Nginx site (port 80 only)
    template:
      src: nginx-site.conf.j2
      dest: "/etc/nginx/sites-available/{{ domain_name }}"
      mode: '0644'
      force: no
    notify: reload nginx

  - name: Enable Nginx site
    file:
      src: "/etc/nginx/sites-available/{{ domain_name }}"
      dest: "/etc/nginx/sites-enabled/{{ domain_name }}"
      state: link
    notify: reload nginx

  - name: Ensure Trojan config directory exists
    file:
      path: /etc/trojan
      state: directory
      mode: '0755'

  - name: Configure Trojan
    template:
      src: trojan-config.json.j2
      dest: /etc/trojan/config.json
      mode: '0644'
      backup: yes
    notify: restart trojan

  - name: Display Trojan password
    debug:
      msg: "Trojan password: {{ trojan_password }}"

  - name: Save Trojan password to file (only if new)
    copy:
      content: "{{ trojan_password }}"
      dest: /root/trojan-password.txt
      mode: '0600'
    when: not password_file.stat.exists

  - name: Configure Let's Encrypt renewal with Trojan deploy hook
    template:
      src: letsencrypt-renewal.conf.j2
      dest: "/etc/letsencrypt/renewal/{{ domain_name }}.conf"
      mode: '0644'
      backup: yes

  - name: Ensure Trojan service is started and enabled
    ansible.builtin.systemd:
      name: trojan
      state: started
      enabled: yes